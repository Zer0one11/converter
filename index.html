<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер файлов SCL ↔ RE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn-upload { background-color: #3b82f6; }
        .btn-download { background-color: #10b981; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        textarea { resize: none; }
    </style>
    <script>
        const FIELD_KEYS = ["ID", "Parameter", "Value", "Unit"];
        const RE_HEADER_PREFIX = "# SOURCE_FILE:";

        let uploadedFile = null;

        /**
         * Отображает сообщение (успех или ошибка) в UI.
         */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-yellow-100', 'text-red-700', 'text-green-700', 'text-yellow-700');
            
            if (type === 'success') {
                messageBox.className = 'p-3 mb-4 rounded-lg border-l-4 font-medium bg-green-100 text-green-700 border-green-400';
            } else if (type === 'error') {
                messageBox.className = 'p-3 mb-4 rounded-lg border-l-4 font-medium bg-red-100 text-red-700 border-red-400';
            } else { // info
                 messageBox.className = 'p-3 mb-4 rounded-lg border-l-4 font-medium bg-yellow-100 text-yellow-700 border-yellow-400';
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 7000);
        }

        /**
         * Вызывается при выборе файла. Считывает его содержимое.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const extension = file.name.split('.').pop().toLowerCase();
            if (extension !== 'scl' && extension !== 're') {
                showMessage(`Неподдерживаемый формат файла: .${extension}. Пожалуйста, загрузите .scl или .re`, 'error');
                document.getElementById('fileInput').value = '';
                return;
            }

            uploadedFile = file;
            document.getElementById('fileNameDisplay').textContent = `Выбран файл: ${file.name}`;
            document.getElementById('downloadButton').classList.add('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('inputArea').value = e.target.result;
                showMessage(`Файл ${file.name} успешно загружен.`, 'success');
                document.getElementById('convertButton').classList.remove('hidden');
            };
            reader.onerror = () => {
                showMessage('Ошибка при чтении файла.', 'error');
                uploadedFile = null;
            };
            reader.readAsText(file);
        }

        /**
         * Основная функция для запуска соответствующей конвертации.
         */
        function startConversion() {
            if (!uploadedFile) {
                showMessage('Пожалуйста, сначала загрузите файл .scl или .re', 'error');
                return;
            }

            const inputFileExtension = uploadedFile.name.split('.').pop().toLowerCase();
            const inputContent = document.getElementById('inputArea').value;
            let outputContent = '';
            let outputFileName = '';
            let conversionSuccess = false;

            document.getElementById('outputArea').value = 'Конвертация...';

            if (inputFileExtension === 'scl') {
                const result = convertSclToRe(inputContent, uploadedFile.name);
                if (result.success) {
                    outputContent = result.data;
                    outputFileName = uploadedFile.name.replace(/\.scl$/i, '.re');
                    conversionSuccess = true;
                }
            } else if (inputFileExtension === 're') {
                const result = convertReToScl(inputContent, uploadedFile.name);
                if (result.success) {
                    outputContent = result.data;
                    outputFileName = uploadedFile.name.replace(/\.re$/i, '.scl');
                    conversionSuccess = true;
                }
            }

            document.getElementById('outputArea').value = outputContent;

            if (conversionSuccess) {
                document.getElementById('downloadButton').classList.remove('hidden');
                document.getElementById('downloadButton').dataset.filename = outputFileName;
                showMessage(`Конвертация успешно выполнена! Получен файл ${outputFileName}.`, 'success');
            } else {
                 document.getElementById('downloadButton').classList.add('hidden');
            }
        }
        
        /**
         * Логика: SCL (JSON) -> RE (CSV с заголовком)
         */
        function convertSclToRe(sclContent, originalFileName) {
            try {
                const records = JSON.parse(sclContent);
                if (!Array.isArray(records)) throw new Error("Ожидался массив записей.");

                // 1. Формирование строки заголовка RE
                const reHeader = `${RE_HEADER_PREFIX} ${originalFileName}`;
                const columnHeader = FIELD_KEYS.join(',');

                // 2. Формирование строк данных
                const dataLines = records.map(record => {
                    return FIELD_KEYS.map(key => {
                        let value = record[key];
                        // Простая защита от CSV инъекций и форматирование строк в кавычки
                        if (typeof value === 'string') {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',');
                });

                const reContent = [reHeader, columnHeader, ...dataLines].join('\n');
                return { success: true, data: reContent };

            } catch (e) {
                showMessage(`Ошибка SCL → RE: Неверный формат JSON. ${e.message}`, 'error');
                return { success: false, data: `Ошибка: ${e.message}` };
            }
        }

        /**
         * Логика: RE (CSV с заголовком) -> SCL (JSON)
         */
        function convertReToScl(reContent, originalFileName) {
            const lines = reContent.trim().split('\n');
            if (lines.length < 2) {
                showMessage('Ошибка RE → SCL: Файл слишком короткий или пустой.', 'error');
                return { success: false, data: 'Ошибка: Файл RE слишком короткий.' };
            }

            // 1. Проверка и удаление заголовка RE
            if (!lines[0].startsWith(RE_HEADER_PREFIX)) {
                 showMessage('Ошибка RE → SCL: Не найден обязательный заголовок RE формата.', 'error');
                 return { success: false, data: 'Ошибка: Отсутствует заголовок RE.' };
            }
            
            // 2. Получение заголовка столбцов (вторая строка)
            const columnHeaderLine = lines[1].trim();
            const columns = columnHeaderLine.split(',').map(c => c.trim());
            
            if (columns.join(',') !== FIELD_KEYS.join(',')) {
                showMessage('Ошибка RE → SCL: Заголовки столбцов не соответствуют ожидаемым (ID, Parameter, Value, Unit).', 'error');
                return { success: false, data: 'Ошибка: Неверные заголовки столбцов.' };
            }
            
            const records = [];
            
            // 3. Парсинг строк данных (начиная с третьей строки)
            try {
                 for (let i = 2; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Простой парсинг CSV
                    const values = line.split(','); 
                    if (values.length !== FIELD_KEYS.length) {
                        throw new Error(`Неверное количество столбцов в строке ${i + 1}.`);
                    }

                    const record = {};
                    record[FIELD_KEYS[0]] = parseInt(values[0]);
                    record[FIELD_KEYS[1]] = values[1].replace(/"/g, ''); // Удаляем кавычки
                    record[FIELD_KEYS[2]] = parseFloat(values[2]);
                    record[FIELD_KEYS[3]] = values[3].replace(/"/g, '');
                    
                    records.push(record);
                }
            } catch (e) {
                 showMessage(`Ошибка парсинга RE → SCL: ${e.message}`, 'error');
                 return { success: false, data: `Ошибка парсинга строки: ${e.message}` };
            }


            // 4. Форматирование в JSON (SCL)
            const sclContent = JSON.stringify(records, null, 2);
            return { success: true, data: sclContent };
        }

        /**
         * Создает Blob из содержимого и предлагает скачать файл.
         */
        function downloadFile() {
            const outputContent = document.getElementById('outputArea').value;
            const outputFileName = document.getElementById('downloadButton').dataset.filename;
            
            if (!outputContent || !outputFileName) {
                showMessage('Нет данных для скачивания.', 'error');
                return;
            }

            const mimeType = outputFileName.endsWith('.scl') ? 'application/json' : 'text/csv';
            const blob = new Blob([outputContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Файл ${outputFileName} успешно скачан.`, 'success');
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl card p-6 md:p-10">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2 text-center">Конвертер Файлов SCL ↔ RE</h1>
        
        <p class="text-sm text-gray-600 mb-6 text-center">
            Загрузите файл **.scl** (JSON-формат) или **.re** (текст, разделенный запятыми) для двустороннего преобразования.
        </p>

        <div id="messageBox" class="hidden p-3 mb-4 rounded-lg border-l-4 font-medium" role="alert"></div>

        <div class="mb-8 p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50">
            <label for="fileInput" class="block text-lg font-bold text-gray-800 mb-3 cursor-pointer">
                1. Выберите файл (.scl или .re):
            </label>
            <input type="file" id="fileInput" onchange="handleFileSelect(event)" accept=".scl,.re" class="hidden">
            
            <label for="fileInput" class="w-full inline-block text-center py-3 px-4 rounded-lg text-white font-semibold cursor-pointer btn-upload hover:bg-blue-700">
                <span id="fileNameDisplay">Нажмите, чтобы выбрать файл</span>
            </label>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div>
                <label for="inputArea" class="block text-lg font-bold text-gray-800 mb-2">Содержимое Входного Файла</label>
                <textarea id="inputArea" rows="15" readonly placeholder="Здесь появится содержимое загруженного файла..."
                          class="w-full p-4 border-2 border-gray-300 bg-gray-100 rounded-lg text-sm text-gray-700"></textarea>
            </div>
            <div>
                <label for="outputArea" class="block text-lg font-bold text-gray-800 mb-2">Содержимое Выходного Файла</label>
                <textarea id="outputArea" rows="15" readonly placeholder="Результат конвертации появится здесь..."
                          class="w-full p-4 border-2 border-gray-300 bg-gray-100 rounded-lg text-sm text-gray-700"></textarea>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            
            <button id="convertButton" onclick="startConversion()" class="btn btn-upload text-white font-semibold py-3 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-300 hidden">
                Выполнить Конвертацию
            </button>
            
            <button id="downloadButton" onclick="downloadFile()" data-filename="" class="btn btn-download text-white font-semibold py-3 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-emerald-300 hidden">
                Скачать Сконвертированный Файл
            </button>

        </div>
    </div>

</body>
</html>
